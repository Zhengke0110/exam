<template>
  <div class="pb-safe min-h-screen bg-gray-50">
    <!-- ËÄÉËØï‰ø°ÊÅØÂºπÁ™ó -->
    <Dialog
      v-model:show="showExamInfo"
      title="ËÄÉËØïÈ°ªÁü•"
      theme="round-button"
      :show-confirm-button="true"
      :show-cancel-button="false"
      confirm-button-text="ÂºÄÂßãËÄÉËØï"
      @confirm="startExam"
    >
      <div class="space-y-4 p-4">
        <div class="text-lg font-semibold text-gray-800">
          {{ examInfo?.description }}
        </div>
        <div class="space-y-2 text-sm text-gray-600">
          <div>ÁßëÁõÆÔºö{{ examInfo?.source }}</div>
          <div>ËÄÉËØïÊó∂ÈïøÔºö{{ examInfo?.totalTime }}ÂàÜÈíü</div>
          <div>ÊÄªÂàÜÔºö{{ examInfo?.totalScore }}ÂàÜ</div>
          <div>ËÄÉËØïÊó∂Èó¥Ôºö{{ examInfo?.examDate }}</div>
          <div
            v-if="examInfo?.tips"
            class="mt-4 rounded-lg bg-blue-50 p-3 text-blue-700"
          >
            <div class="flex items-center">
              <span class="mr-2">üí°</span>
              {{ examInfo.tips }}
            </div>
          </div>
        </div>
      </div>
    </Dialog>

    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
    <div class="fixed inset-x-0 top-0 z-50 bg-white">
      <div class="safe-area-top bg-white"></div>
      <div class="flex items-center justify-between border-b p-4">
        <div class="flex items-center space-x-2">
          <NavBar title="ËÄÉËØïËøõË°å‰∏≠" left-arrow @click-left="handleBack" />
        </div>
        <div class="flex items-center space-x-4">
          <span class="text-sm text-gray-600">
            È¢òÁõÆ {{ currentIndex + 1 }}/{{ questions.length }}
          </span>
          <span
            class="text-sm"
            :class="
              remainingTime < 300
                ? 'animate-pulse text-red-600'
                : 'text-blue-600'
            "
          >
            Ââ©‰ΩôÔºö{{ formatTime(remainingTime) }}
          </span>
        </div>
      </div>
    </div>

    <!-- ÊµÆÂä®ÊåâÈíÆ - ÊòæÁ§∫Á≠îÈ¢òÂç° -->
    <div class="fixed top-20 right-4 z-40">
      <button
        class="flex h-12 w-12 items-center justify-center rounded-full bg-blue-500 text-white shadow-lg transition-all hover:bg-blue-600"
        @click="showAnswerCard = true"
      >
        <span class="text-lg">üìù</span>
      </button>
    </div>

    <!-- Á≠îÈ¢òÂç°È¢ÑËßàÈù¢Êùø -->
    <Popup
      v-model:show="showAnswerCard"
      position="right"
      :style="{ height: '100%', width: '80%' }"
    >
      <div class="flex h-full flex-col bg-white">
        <!-- Á≠îÈ¢òÂç°Ê†áÈ¢ò -->
        <div class="border-b p-4">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Á≠îÈ¢òÂç°</h3>
            <span class="text-sm text-gray-500">
              Â∑≤Á≠î {{ Object.keys(userAnswers).length }}/{{ questions.length }}
            </span>
          </div>
        </div>

        <!-- Á≠îÈ¢òËøõÂ∫¶Ê¶ÇËßà -->
        <div class="border-b p-4">
          <Progress
            :percentage="progressPercentage"
            :pivot-text="progressText"
            color="#1989fa"
          />
        </div>

        <!-- È¢òÁõÆÂàóË°® -->
        <div class="flex-1 overflow-y-auto p-4">
          <div class="grid grid-cols-4 gap-3">
            <button
              v-for="(question, index) in questions"
              :key="index"
              class="aspect-square rounded-lg border-2 p-2 text-center transition-all"
              :class="[
                userAnswers[index]
                  ? 'border-blue-500 bg-blue-50 text-blue-600'
                  : 'border-gray-200 text-gray-600',
                currentIndex === index
                  ? 'ring-2 ring-blue-500 ring-offset-2'
                  : '',
              ]"
              @click="jumpToQuestion(index)"
            >
              <span class="text-sm">{{ index + 1 }}</span>
              <div class="mt-1 text-xs">
                {{ getQuestionTypeShort(question.type) }}
              </div>
            </button>
          </div>
        </div>

        <!-- Âõæ‰æãËØ¥Êòé -->
        <div class="border-t p-4">
          <div class="flex items-center justify-around text-sm">
            <div class="flex items-center">
              <div class="mr-2 h-3 w-3 rounded border-2 border-gray-200"></div>
              <span>Êú™Á≠îÈ¢ò</span>
            </div>
            <div class="flex items-center">
              <div
                class="mr-2 h-3 w-3 rounded border-2 border-blue-500 bg-blue-50"
              ></div>
              <span>Â∑≤Á≠îÈ¢ò</span>
            </div>
            <div class="flex items-center">
              <div
                class="mr-2 h-3 w-3 rounded ring-2 ring-blue-500 ring-offset-2"
              ></div>
              <span>ÂΩìÂâçÈ¢ò</span>
            </div>
          </div>
        </div>
      </div>
    </Popup>

    <!-- È¢òÁõÆÂÜÖÂÆπÂå∫Âüü -->
    <div class="mt-[72px] px-4 pb-32">
      <Transition mode="out-in" name="fade">
        <div
          v-if="currentQuestion"
          :key="currentIndex"
          class="rounded-lg bg-white p-4 shadow-sm"
        >
          <!-- È¢òÁõÆ‰ø°ÊÅØ -->
          <div class="mb-4 flex items-center justify-between">
            <Tag type="primary" size="medium">{{ currentQuestion.type }}</Tag>
            <span class="text-sm text-gray-500"
              >{{ currentQuestion.score }}ÂàÜ</span
            >
          </div>

          <!-- È¢òÁõÆÂÜÖÂÆπ -->
          <div class="mb-6 text-lg">{{ currentQuestion.question }}</div>

          <!-- Á≠îÈ¢òÂå∫Âüü -->
          <Transition name="fade-up" mode="out-in">
            <!-- ÂçïÈÄâÈ¢ò -->
            <div
              v-if="currentQuestion.type === AnswerType.SINGLE"
              class="space-y-3"
            >
              <div
                v-for="option in ['A', 'B', 'C', 'D']"
                :key="option"
                class="transform transition-all duration-300"
                :class="{
                  'scale-102': userAnswers[currentIndex] === option,
                }"
              >
                <Cell
                  :title="`${option}: ${currentQuestion[('answer' + option) as keyof typeof currentQuestion]}`"
                  clickable
                  class="option-cell"
                  :class="{
                    'option-selected': userAnswers[currentIndex] === option,
                  }"
                  @click="selectAnswer(option)"
                >
                  <template #icon>
                    <div
                      class="mr-3 flex h-8 w-8 items-center justify-center rounded-full border-2 transition-all duration-300"
                      :class="{
                        'border-blue-500 bg-blue-50':
                          userAnswers[currentIndex] === option,
                        'border-gray-300': userAnswers[currentIndex] !== option,
                      }"
                    >
                      {{ option }}
                    </div>
                  </template>
                </Cell>
              </div>
            </div>

            <!-- Âà§Êñ≠È¢ò -->
            <div
              v-else-if="currentQuestion.type === AnswerType.JUDGE"
              class="space-y-3"
            >
              <Cell
                v-for="[value, label] in [
                  ['T', 'Ê≠£Á°Æ'],
                  ['F', 'ÈîôËØØ'],
                ]"
                :key="value"
                clickable
                class="option-cell"
                :class="{
                  'option-selected': userAnswers[currentIndex] === value,
                }"
                @click="selectAnswer(value)"
              >
                <template #icon>
                  <div
                    class="mr-3 flex h-8 w-8 items-center justify-center rounded-full border-2 transition-all duration-300"
                    :class="{
                      'border-blue-500 bg-blue-50':
                        userAnswers[currentIndex] === value,
                      'border-gray-300': userAnswers[currentIndex] !== value,
                    }"
                  >
                    {{ value }}
                  </div>
                </template>
                <template #title>
                  <span class="text-base">{{ label }}</span>
                </template>
              </Cell>
            </div>

            <!-- Â°´Á©∫È¢ò -->
            <div
              v-else-if="currentQuestion.type === AnswerType.FILL"
              class="space-y-3"
            >
              <Field
                v-model="userAnswers[currentIndex]"
                type="textarea"
                rows="3"
                placeholder="ËØ∑ËæìÂÖ•Á≠îÊ°à"
                class="rounded-lg border"
              />
            </div>
          </Transition>
        </div>
      </Transition>
    </div>

    <!-- Â∫ïÈÉ®Êìç‰ΩúÊ†è -->
    <div class="shadow-up fixed inset-x-0 bottom-0 bg-white">
      <div class="flex items-center justify-between p-4">
        <Button plain @click="prevQuestion" :disabled="currentIndex === 0"
          >‰∏ä‰∏ÄÈ¢ò</Button
        >
        <div class="flex-1 px-4">
          <Progress
            :percentage="progressPercentage"
            :pivot-text="progressText"
          />
        </div>
        <Button
          type="primary"
          @click="nextQuestion"
          :text="isLastQuestion ? 'Êèê‰∫§' : '‰∏ã‰∏ÄÈ¢ò'"
        />
      </div>
      <div class="safe-area-bottom bg-white"></div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, onUnmounted } from "vue";
import {
  Cell,
  Field,
  Button,
  Tag,
  Progress,
  showDialog,
  NavBar,
  Dialog,
  Popup,
  showToast,
} from "vant";
import { GetPaperByPaperIdApi, GetExamInfoApi } from "@/services";
import type { AnswerDetail, ExamManage } from "@/services";
import { AnswerType } from "@/services";
import { useRouter } from "vue-router";
import type { ExamResult, WrongQuestion } from "@/types/exam";

const router = useRouter();
const props = defineProps<{ examCode: string }>();
const questions = ref<AnswerDetail[]>([]);
const currentIndex = ref(0);
const userAnswers = ref<Record<number, string>>({});
const remainingTime = ref(7200); // 2Â∞èÊó∂

const currentQuestion = computed(() => questions.value[currentIndex.value]);
const isLastQuestion = computed(
  () => currentIndex.value === questions.value.length - 1,
);

const progressPercentage = computed(() => {
  if (!questions.value.length) return 0;
  const answered = Object.keys(userAnswers.value).length;
  return Math.round((answered / questions.value.length) * 100) || 0;
});

const progressText = computed(() => {
  if (!questions.value.length) return "0/0";
  return `${Object.keys(userAnswers.value).length}/${questions.value.length}`;
});

const formatTime = (seconds: number) => {
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = seconds % 60;
  return `${h.toString().padStart(2, "0")}:${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
};

const selectAnswer = (answer: string) => {
  userAnswers.value[currentIndex.value] = answer;
};

const nextQuestion = async () => {
  if (isLastQuestion.value) {
    await handleSubmit();
    return;
  }
  currentIndex.value++;
};

const prevQuestion = () => {
  if (currentIndex.value > 0) {
    currentIndex.value--;
  }
};

const examResult = ref<ExamResult>({
  examCode: 0,
  score: 0,
  totalScore: 0,
  correctCount: 0,
  totalCount: 0,
  wrongQuestions: [],
  submitTime: "",
});

// Âà§È¢òÂáΩÊï∞
const gradeExam = () => {
  const result = examResult.value;
  result.examCode = Number(props.examCode);
  result.totalCount = questions.value.length;
  result.totalScore = questions.value.reduce((sum, q) => sum + q.score, 0);
  result.submitTime = new Date().toISOString();

  let totalScore = 0;
  let correctCount = 0;
  const wrongQuestions: WrongQuestion[] = [];

  questions.value.forEach((question, index) => {
    const userAnswer = userAnswers.value[index];
    const isCorrect = checkAnswer(question, userAnswer);

    if (isCorrect) {
      totalScore += question.score;
      correctCount++;
    } else {
      wrongQuestions.push({
        questionId: question.questionId,
        question: question.question,
        type: question.type,
        yourAnswer: userAnswer || "Êú™‰ΩúÁ≠î",
        rightAnswer: question.rightAnswer || "",
        score: question.score,
        analysis: question.analysis,
      });
    }
  });

  result.score = totalScore;
  result.correctCount = correctCount;
  result.wrongQuestions = wrongQuestions;

  return result;
};

// Ê£ÄÊü•Á≠îÊ°àÊòØÂê¶Ê≠£Á°Æ
const checkAnswer = (question: AnswerDetail, userAnswer?: string): boolean => {
  if (!userAnswer) return false;

  switch (question.type) {
    case AnswerType.JUDGE:
      return userAnswer.toUpperCase() === question.rightAnswer?.toUpperCase();
    case AnswerType.SINGLE:
      return userAnswer.toUpperCase() === question.rightAnswer?.toUpperCase();
    case AnswerType.FILL:
      // Â°´Á©∫È¢òÂèØËÉΩÈúÄË¶ÅÊ®°Á≥äÂåπÈÖçÊàñËÄÖÂÖ∂‰ªñÂåπÈÖçËßÑÂàô
      return userAnswer.trim() === question.rightAnswer?.trim();
    default:
      return false;
  }
};

// ‰øÆÊîπÊèê‰∫§ÂáΩÊï∞
const handleSubmit = async (auto = false) => {
  try {
    // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÈ¢òÁõÆÈÉΩÂ∑≤‰ΩúÁ≠î
    const unansweredCount =
      questions.value.length - Object.keys(userAnswers.value).length;

    if (!auto && unansweredCount > 0) {
      const result = await showDialog({
        title: "ÊèêÁ§∫",
        message: `ËøòÊúâ ${unansweredCount} ÈÅìÈ¢òÊú™‰ΩúÁ≠îÔºåÁ°ÆÂÆöË¶ÅÊèê‰∫§ÂêóÔºü`,
        showCancelButton: true,
      });

      if (result === "cancel") return;
    }

    const confirmResult = await showDialog({
      title: auto ? "Ëá™Âä®Êèê‰∫§" : "Á°ÆËÆ§Êèê‰∫§",
      message: auto
        ? "ËÄÉËØïÊó∂Èó¥Â∑≤ÁªìÊùüÔºåÁ≥ªÁªüÂ∞ÜËá™Âä®Êèê‰∫§ËØïÂç∑"
        : "Êèê‰∫§ÂêéÂ∞ÜÊó†Ê≥ï‰øÆÊîπÁ≠îÊ°àÔºåÊòØÂê¶Á°ÆËÆ§Êèê‰∫§Ôºü",
      showCancelButton: !auto,
    });

    if (confirmResult === "confirm") {
      // ËøõË°åÂà§È¢ò
      const result = gradeExam();

      try {
        // TODO: Ë∞ÉÁî®API‰øùÂ≠òËÄÉËØïÁªìÊûú
        // await submitExamResult(result);

        // Â∞ÜÁªìÊûúÂ≠òÂÖ•Êú¨Âú∞Â≠òÂÇ®ÔºåÁî®‰∫éÁªìÊûúÈ°µÈù¢ÊòæÁ§∫
        localStorage.setItem("lastExamResult", JSON.stringify(result));

        // ÊòæÁ§∫ËÄÉËØïÁªìÊûúÊëòË¶Å
        await showDialog({
          title: "ËÄÉËØïÂÆåÊàê",
          message: `ÂæóÂàÜÔºö${result.score}/${result.totalScore}\nÊ≠£Á°ÆÁéáÔºö${Math.round((result.correctCount / result.totalCount) * 100)}%`,
          confirmButtonText: "Êü•ÁúãËØ¶ÊÉÖ",
        });

        router.push({
          path: "/exam-result",
          query: { examCode: props.examCode },
        });
      } catch (error) {
        showToast("Êèê‰∫§Â§±Ë¥•ÔºåËØ∑ÈáçËØï");
      }
    }
  } catch (error) {
    console.error(error);
  }
};

const examInfo = ref<ExamManage | null>(null);
const showExamInfo = ref(true);
const examStarted = ref(false);
let timer: number;

// Â§ÑÁêÜËÄÉËØïÂºÄÂßã
const startExam = () => {
  if (!examInfo.value?.totalTime) return;

  examStarted.value = true;
  remainingTime.value = examInfo.value.totalTime * 60; // ËΩ¨Êç¢‰∏∫Áßí
  startTimer();
};

// Â§ÑÁêÜËøîÂõûÊåâÈíÆ
const handleBack = async () => {
  try {
    const result = await showDialog({
      title: "Á°ÆËÆ§Á¶ªÂºÄ",
      message: "Á¶ªÂºÄËÄÉËØïÂ∞ÜË¢´ËÆ∞‰∏∫‰∫§Âç∑ÔºåÁ°ÆÂÆöË¶ÅÈÄÄÂá∫ÂêóÔºü",
      showCancelButton: true,
    });

    if (result === "confirm") {
      await handleSubmit(true);
    }
  } catch (error) {
    // Áî®Êà∑ÂèñÊ∂à
  }
};

// Ëá™Âä®Êèê‰∫§
const autoSubmit = () => {
  showDialog({
    title: "ËÄÉËØïÊó∂Èó¥Âà∞",
    message: "ËÄÉËØïÊó∂Èó¥Â∑≤ÁªìÊùüÔºåÁ≥ªÁªüÂ∞ÜËá™Âä®Êèê‰∫§ËØïÂç∑",
    showCancelButton: false,
  }).then(() => {
    handleSubmit(true);
  });
};

onMounted(async () => {
  try {
    // Ëé∑ÂèñËÄÉËØï‰ø°ÊÅØ
    const { data } = await GetExamInfoApi(Number(props.examCode));
    examInfo.value = data as ExamManage;

    // Ê£ÄÊü•ËÄÉËØïÊó∂Èó¥
    if (examInfo.value?.examDate) {
      const examDate = new Date(examInfo.value.examDate);
      const now = new Date();
      if (examDate > now) {
        showDialog({
          title: "ËÄÉËØïÊú™ÂºÄÂßã",
          message: "ËØ∑Âú®ËÄÉËØïÂºÄÂßãÊó∂Èó¥ÂêéÂèÇÂä†ËÄÉËØï",
          showCancelButton: false,
        }).then(() => {
          router.back();
        });
        return;
      }
    }

    // Ëé∑ÂèñËØïÂç∑ÂÜÖÂÆπ
    const res = await GetPaperByPaperIdApi(Number(props.examCode));
    questions.value = res as AnswerDetail[];
  } catch (error) {
    showDialog({
      title: "Âä†ËΩΩÂ§±Ë¥•",
      message: "ËØïÂç∑Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï",
      showCancelButton: false,
    }).then(() => {
      router.back();
    });
  }
});

// ‰øÆÊîπËÆ°Êó∂Âô®ÈÄªËæë
const startTimer = () => {
  timer = window.setInterval(() => {
    if (remainingTime.value > 0) {
      remainingTime.value--;

      // ÊúÄÂêé5ÂàÜÈíüÊèêÈÜí
      if (remainingTime.value === 300) {
        showDialog({
          title: "Êó∂Èó¥ÊèêÈÜí",
          message: "Ë∑ùÁ¶ªËÄÉËØïÁªìÊùüËøòÊúâ5ÂàÜÈíüÔºåËØ∑Ê≥®ÊÑèÊääÊè°Êó∂Èó¥",
          showCancelButton: false,
        });
      }
    } else {
      clearInterval(timer);
      autoSubmit();
    }
  }, 1000);
};

onUnmounted(() => {
  clearInterval(timer);
});

// Ê∑ªÂä†Á≠îÈ¢òÂç°ÊéßÂà∂ÂèòÈáè
const showAnswerCard = ref(false);

// Ëé∑ÂèñÈ¢òÁõÆÁ±ªÂûãÁÆÄÂÜô
const getQuestionTypeShort = (type: string) => {
  switch (type) {
    case AnswerType.SINGLE:
      return "ÂçïÈÄâ";
    case AnswerType.JUDGE:
      return "Âà§Êñ≠";
    case AnswerType.FILL:
      return "Â°´Á©∫";
    default:
      return "ÂÖ∂‰ªñ";
  }
};

// Ë∑≥ËΩ¨Âà∞ÊåáÂÆöÈ¢òÁõÆ
const jumpToQuestion = (index: number) => {
  currentIndex.value = index;
  showAnswerCard.value = false;
};
</script>

<style scoped>
.safe-area-top {
  height: env(safe-area-inset-top);
}

.safe-area-bottom {
  height: env(safe-area-inset-bottom);
}

.pb-safe {
  padding-bottom: env(safe-area-inset-bottom);
}

.shadow-up {
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
}

/* ËøáÊ∏°Âä®Áîª */
.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.3s ease;
}

.fade-enter-from,
.fade-leave-to {
  opacity: 0;
}

.fade-up-enter-active,
.fade-up-leave-active {
  transition: all 0.3s ease;
}

.fade-up-enter-from {
  opacity: 0;
  transform: translateY(20px);
}

.fade-up-leave-to {
  opacity: 0;
  transform: translateY(-20px);
}

:deep(.van-field__control) {
  min-height: 100px;
}

:deep(.van-cell) {
  margin-bottom: 8px;
  border-radius: 8px;
  transition: all 0.3s ease;
}

:deep(.van-progress) {
  height: 8px;
  border-radius: 4px;
}

/* ÈÄâÈ°πÊ†∑Âºè */
:deep(.option-cell) {
  margin-bottom: 0.75rem;
  border-radius: 1rem;
  border-width: 2px;
  border-color: transparent;
  padding: 1rem;
  transition-property: all;
  transition-duration: 300ms;
}

:deep(.option-cell.option-selected) {
  border-color: #63b3ed;
  background-color: #eff6ff;
  transform: translateX(8px);
}

:deep(.option-cell:active) {
  background-color: #e0f7fa;
}

:deep(.van-cell__title) {
  display: flex;
  align-items: center;
  font-size: 1rem;
}

:deep(.van-cell__value) {
  display: flex;
  align-items: center;
}

:deep(.van-cell) {
  transition-property: all;
  transition-duration: 300ms;
  background-color: transparent;
}

:deep(.van-cell:hover) {
  background-color: #f9fafb;
}
.scale-102 {
  transform: scale(1.02);
}

/* Ê∑ªÂä†Èó™ÁÉÅÂä®Áîª */
@keyframes pulse {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

.animate-pulse {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

/* Á≠îÈ¢òÂç°Ê†∑Âºè */
:deep(.van-popup) {
  border-top-left-radius: 1rem;
  border-bottom-left-radius: 1rem;
}

/* ÊªöÂä®Êù°ÁæéÂåñ */
.overflow-y-auto {
  scrollbar-width: thin;
  scrollbar-color: #e2e8f0 #f8fafc;
}

.overflow-y-auto::-webkit-scrollbar {
  width: 6px;
}

.overflow-y-auto::-webkit-scrollbar-track {
  background: #f8fafc;
}

.overflow-y-auto::-webkit-scrollbar-thumb {
  background-color: #e2e8f0;
  border-radius: 3px;
}
</style>
